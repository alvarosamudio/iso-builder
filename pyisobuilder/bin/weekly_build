#! /usr/bin/env python2
# -*- coding: utf-8 -*-
#

import os
import sys
sys.path.append("..")
from src import iso
import datetime

logfile=None
time_stamp=datetime.datetime.now().strftime("%Y%m%d")
os.chdir("..")

try:
    arch=sys.argv[1]
except:
    print("Oops,error detect.Treat default arch as amd64")
    arch='amd64'
N=iso.IsoBuilder('build', '/home/isobuilder/pyisobuilder/conf/weekly/data', '/home/isobuilder/pyisobuilder/conf/weekly/config', 'trusty', arch, '/home/isobuilder/pyisobuilder/debootstrap', logfile, tmpfs_size='8g')
try:
    N.create_debootstrap()
    N.make_desktop()
    N.custom_desktop()

    if arch == 'amd64':
        N.prepare_cdrom_repository(include_packages=['grub-pc', 'grub-efi', 'grub-efi-amd64-signed', 'linux-signed-generic','linux-firmware-nonfree'])
    
    if arch == 'i386':
        N.prepare_cdrom_repository(include_packages=['grub-pc','linux-firmware-nonfree'])
    
    N.prepare_overlay_squashfs(langs=['dummy'])
    N.prepare_iso()
    iso_fullpath=os.path.join('/home/isobuilder/pyisobuilder','output', 'weekly','deepin-%s-%s.iso' % (time_stamp,arch))
    N.make_iso(imgname=iso_fullpath)
finally:
    N.clean()
