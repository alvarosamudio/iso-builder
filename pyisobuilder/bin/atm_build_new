#! /usr/bin/env python2
# -*- coding: utf-8 -*-
#

import sys
sys.path.append("..")
from src import iso
import os
import time

os.chdir("..")
logfile=None

BASEDIR = "/data/pyisobuilder"

if len(sys.argv) != 2:
    raise OSError("arch amd64 or i386 ...")
else:
    arch = sys.argv[1]

name = os.path.basename(sys.argv[0]).replace('_build', '')

if not os.path.exists(os.path.join(BASEDIR,"conf", name)):
    raise OSError("No config path exists")

_data = os.path.join(BASEDIR, 'conf', name, 'data')
_config = os.path.join(BASEDIR, 'conf', name, 'config')
_debootstrap = os.path.join(BASEDIR, 'debootstrap')

mini=iso.IsoBuilder(isobuildpath='build', 
        datadir=os.path.join(BASEDIR, 'conf', name, 'data.mini'), 
        configdir=os.path.join(BASEDIR, 'conf', name, 'config.mini'), 
        codename='trusty', arch=arch,
        debootstrap = _debootstrap, logfile=logfile, tmpfs_size='8g')

build = False
try:
    mini.create_debootstrap()
    mini.make_desktop()
    mini.custom_desktop()
    mini.make_squashfs()
    _build = True
finally:
    mini.clean(clean_iso_build=False)

N=iso.IsoBuilder('build', _data, _config, 'trusty', arch, _debootstrap, logfile, tmpfs_size='8g')
try:
    N.create_debootstrap()
    N.make_desktop()
    N.custom_desktop()
    if arch == 'amd64':
        N.prepare_cdrom_repository(include_packages=['grub-pc', 'grub-efi'])
    
    if arch == 'i386':
        N.prepare_cdrom_repository(include_packages=['grub-pc', 'grub-efi'])
    
    N.prepare_iso()
    output_path = os.path.join(BASEDIR,'output','atm',time.strftime("%Y%m%d",time.localtime()))
    if not os.path.exists(output_path):
        os.makedirs(output_path)
    iso_fullpath=os.path.join(output_path,'deepin-%s-%s.iso' % (name, arch))
    N.make_iso(imgname=iso_fullpath)
    N.make_dailylink(output_path)
finally:
    N.clean()
